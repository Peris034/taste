<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyStore - Find Your Next Gadget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
    
    <script>
        // --- 1. (IMPROVED) Initialize dataLayer and add Page-Level data ---
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
            'page_type': 'Homepage'
        });
    </script>
    
    <script src="store.js"></script>

    <script>
        // --- 2. Get Product/Promo Data ---
        const products = [productDB["GADGET-001"], productDB["GADGET-PRO"], productDB["GADGET-MINI"]];
        const promo = promotionsDB["PROMO-SUMMER"];
        
        // --- 3. MAP PRODUCTS FOR JSON-LD MICRODATA ---
        
        // Helper function to get image URL based on ID
        function getImageUrl(productId) {
            if (productId === 'GADGET-PRO') {
                return 'https://placehold.co/600x400/93C5FD/white?text=Gadget+Pro';
            } else if (productId === 'GADGET-MINI') {
                return 'https://placehold.co/600x400/A5B4FC/white?text=Gadget+Mini';
            } else {
                return 'https://placehold.co/600x400/3B82F6/white?text=The+Classic+Gadget';
            }
        }
        
        // Get the base URL (e.g., "https://www.mystore.com")
        const baseUrl = window.location.origin;

        // Map products into Schema.org format
        const jsonLdItemList = products.map((product, index) => {
            return {
                "@type": "ListItem",
                "position": index + 1,
                "item": {
                    "@type": "Product",
                    "name": product.item_name,
                    "description": `Check out ${product.item_name} from MyStore.`,
                    "sku": product.item_id,
                    "image": getImageUrl(product.item_id),
                    "url": `${baseUrl}/product.html?id=${product.item_id}`,
                    "offers": {
                        "@type": "Offer",
                        "priceCurrency": "USD",
                        "price": product.price.toString(),
                        "availability": "https://schema.org/InStock"
                    },
                    "brand": {
                         "@type": "Brand",
                         "name": product.item_brand
                    }
                }
            };
        });

        // Create the final JSON-LD script object
        const jsonLdScriptData = {
            "@context": "https://schema.org",
            "@type": "ItemList",
            "itemListElement": jsonLdItemList
        };

        // --- 4. WRITE THE JSON-LD SCRIPT TO THE <head> ---
        const script = document.createElement('script');
        script.type = 'application/ld+json';
        script.text = JSON.stringify(jsonLdScriptData);
        document.head.appendChild(script);


        // --- 5. GA4/GTM Event Pushes ---
        
        // Event 1: 'view_promotion' (GA4 Standard)
        window.dataLayer.push({
            'event': 'view_promotion',
            'ecommerce': {
                'creative_name': promo.creative_name,
                'creative_slot': promo.creative_slot,
                'promotion_id': promo.promotion_id,
                'promotion_name': promo.promotion_name,
                'items': [] 
            }
        });

        // Event 2: 'view_item_list' (GA4 Standard)
        const itemsForDataLayer = products.map((item, index) => ({
            item_id: item.item_id,
            item_name: item.item_name,
            item_brand: item.item_brand,
            item_category: item.item_category,
            item_variant: item.item_variant,
            price: item.price,
            index: index,
            item_list_id: 'homepage_grid',
            item_list_name: 'Homepage Product Grid'
        }));

        window.dataLayer.push({
            'event': 'view_item_list',
            'ecommerce': {
                'item_list_id': 'homepage_grid',
                'item_list_name': 'Homepage Product Grid',
                'items': itemsForDataLayer
            }
        });
    </script>

    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TTMTP9T2');</script>
    </head>

<body class="bg-gray-100">
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TTMTP9T2" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto max-w-6xl px-4 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-600">MyStore</a>
            <div class="flex items-center space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-blue-600 font-semibold">
                    Home
                </a>
                <a href="about.html" class="text-gray-600 hover:text-blue-600 font-semibold">
                    About Us
                </a>
                <a href="wishlist.html" id="wishlistLink" class="text-gray-600 hover:text-blue-600 font-semibold" style="display: none;">
                    Wishlist
                </a>
                <a href="cart.html" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-semibold hover:bg-blue-200 transition duration-300">
                    Cart (<span id="cartCount">0</span>)
                </a>
                <button id="loginBtn"
                    class="bg-blue-500 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-300">
                    Login
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto max-w-6xl mt-12 mb-12 px-4">
        <a href="#products" id="promoBanner" class="block bg-blue-600 text-white p-16 rounded-lg shadow-xl text-center hover:bg-blue-700 transition">
            <h1 class="text-5xl font-bold">Summer Kick-off!</h1>
            <p class="text-2xl mt-4">Get 5% off all audio gadgets. Click here to see products.</p>
        </a>
    </div>

    <div class="container mx-auto max-w-6xl mt-16 mb-16 px-4" id="products">
        <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Our Products</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <a href="product.html?id=GADGET-001" class="product-link" data-index="0">
                    <img src="https://placehold.co/600x400/3B82F6/white?text=The+Classic+Gadget" alt="The Classic Gadget" class="w-full h-48 object-cover">
                </a>
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800">The Classic Gadget</h3>
                    <p class="text-2xl font-bold text-blue-600 mt-2">$99.99</p>
                    <button 
                        class="addToCartBtn w-full mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-300"
                        data-index="0">
                        Add to Cart
                    </button>
                </div>
            </div>
            
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <a href="product.html?id=GADGET-PRO" class="product-link" data-index="1">
                    <img src="https://placehold.co/600x400/93C5FD/white?text=Gadget+Pro" alt="Gadget Pro" class="w-full h-48 object-cover">
                </a>
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800">The Gadget Pro</h3>
                    <p class="text-2xl font-bold text-blue-600 mt-2">$149.99</p>
                    <button 
                        class="addToCartBtn w-full mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-300"
                        data-index="1">
                        Add to Cart
                    </button>
                </div>
            </div>
            
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <a href="product.html?id=GADGET-MINI" class="product-link" data-index="2">
                    <img src="https://placehold.co/600x400/A5B4FC/white?text=Gadget+Mini" alt="Gadget Mini" class="w-full h-48 object-cover">
                </a>
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800">The Gadget Mini</h3>
                    <p class="text-2xl font-bold text-blue-600 mt-2">$49.99</p>
                    <button 
                        class="addToCartBtn w-full mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-300"
                        data-index="2">
                        Add to Cart
                    </Cta>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center p-12 text-gray-500 text-sm">
        Â© 2025 MyStore. All rights reserved.
    </footer>

    <script>
        // --- STANDARD EVENT: select_promotion ---
        const promoBanner = document.getElementById('promoBanner');
        if (promoBanner) {
            promoBanner.addEventListener('click', function() {
                const promo = promotionsDB["PROMO-SUMMER"]; // from store.js
                console.log('Promotion clicked! Pushing select_promotion...');
                window.dataLayer.push({
                    'event': 'select_promotion',
                    'ecommerce': {
                        'creative_name': promo.creative_name,
                        'creative_slot': promo.creative_slot,
                        'promotion_id': promo.promotion_id,
                        'promotion_name': promo.promotion_name,
                        'items': []
                    }
                });
            });
        }
        
        // --- STANDARD EVENT: select_item ---
        const productLinks = document.querySelectorAll('.product-link');
        productLinks.forEach(link => {
            link.addEventListener('click', function() {
                const productIndex = parseInt(link.getAttribute('data-index'));
                const product = products[productIndex]; // 'products' is from <head>
                
                console.log('Product link clicked! Pushing select_item...');
                window.dataLayer.push({
                    'event': 'select_item',
                    'ecommerce': {
                        'item_list_id': 'homepage_grid',
                        'item_list_name': 'Homepage Product Grid',
                        'items': [product] // Just the item that was clicked
                    }
                });
            });
        });

        // --- STANDARD EVENT: add_to_cart ---
        const allAddToCartButtons = document.querySelectorAll('.addToCartBtn');
        allAddToCartButtons.forEach(button => {
            button.addEventListener('click', function() {
                const productIndex = parseInt(button.getAttribute('data-index'));
                const product = products[productIndex]; // 'products' is from <head>
                
                // This function is in store.js
                // It handles adding to localStorage and pushing to dataLayer
                addItemToCart(product, 'homepage_grid', 'Homepage Product Grid', productIndex); 
            });
        });

        // --- Run on page load ---
        updateCartCount(); // This function is in store.js
    </script>
</body>
</html>